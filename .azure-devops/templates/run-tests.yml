parameters:
  pythonVersion: ''
  runUnitTests: 'false'
  runIntTests: 'true'
  runWithAzureCliReleased: 'false'
  path: 'azext_iot/tests'
  name: 'All'

steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: ${{ parameters.pythonVersion }}
      architecture: 'x64'

  - ${{ if eq(parameters.runWithAzureCliReleased, 'false') }}:
    - template: install-azure-cli-edge.yml

  - ${{ if eq(parameters.runWithAzureCliReleased, 'true') }}:
    - template: install-azure-cli-released.yml

  - template: download-install-local-azure-test-sdk.yml

  - template: setup-ci-machine.yml

  - template: download-install-local-azure-iot-cli-extension.yml

  - template: set-pythonpath.yml

  - template: set-testenv-sentinel.yml

  - ${{ if eq(parameters.runIntTests, 'true') }}:
    - task: AzureCLI@2
      displayName: '${{ parameters.name }} integration tests'
      inputs:
        azureSubscription: AzIoTCLIService
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: pytest -vv ${{ parameters.path }} -k "_int"  --junitxml=junit/test-iotext-int-${{ parameters.name }}.xml

  - ${{ if eq(parameters.runUnitTests, 'true') }}:
    - script: pytest -vv ${{ parameters.path }} -k "_unit" --cov=azext_iot --cov-config .coveragerc --junitxml=junit/test-iotext-unit-${{ parameters.name }}.xml --cov-report=xml
      displayName: '${{ parameters.name }} unit tests'
  
    - task: PublishCodeCoverageResults@1
      inputs:
        codeCoverageTool: 'cobertura'
        summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage.xml'
        reportDirectory: '$(System.DefaultWorkingDirectory)/htmlcov'
        additionalCodeCoverageFiles: '$(System.DefaultWorkingDirectory)/htmlcov/**/*.*'

  - task: PublishTestResults@2
    condition: succeededOrFailed()
    displayName: 'Publish Test Results'
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '**/test-*.xml'
      testRunTitle: 'Publish ${{ parameters.name }} test results for Python ${{ parameters.pythonVersion }} on OS $(Agent.OS)'
      searchFolder: '$(System.DefaultWorkingDirectory)'

  - script: 'pip install .'
    displayName: 'Install the whl locally'
    workingDirectory: '.'

  - task: PythonScript@0
    displayName : 'setupVersion'
    name: 'setupVersion'
    inputs:
      scriptSource: 'inline'
      script: |
        from azext_iot.constants import VERSION
        print("Version is " + VERSION)
        print("##vso[task.setvariable variable=CLIVersion;isOutput=true]"+VERSION)
        print("##vso[task.setvariable variable=ReleaseTitle;isOutput=true]"+"azure-iot "+VERSION)
